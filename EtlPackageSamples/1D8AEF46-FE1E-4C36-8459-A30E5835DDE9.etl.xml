<?xml version="1.0" encoding="utf-8"?>
<EtlPackage xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
  <Id>1D8AEF46-FE1E-4C36-8459-A30E5835DDE9</Id>
  <Name>NewOrdersProcess1CResponse</Name>
	<RunIntervalSeconds>0</RunIntervalSeconds>
	<Enabled>false</Enabled>
	<Variables>
		<Variable>
			<Name>Temp</Name>
			<Modifier>Input</Modifier>
			<DefaultValue>C:\Temp</DefaultValue>
			<Binding>None</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
		<Variable>
			<Name>LoyaltyProgramId</Name>
			<Modifier>Input</Modifier>
			<DefaultValue>1</DefaultValue>
			<Binding>None</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
		<Variable>
			<Name>FileTypeId</Name>
			<Modifier>Input</Modifier>
			<DefaultValue>2</DefaultValue>
			<Binding>None</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
		<Variable>
			<Name>FileMask</Name>
			<Modifier>Input</Modifier>
			<DefaultValue>^(?&lt;name&gt;(neworders)_(?&lt;num&gt;0*[1-9][0-9]{0,9})_resp)\.xml$</DefaultValue>
			<Binding>None</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
		<Variable>
			<Name>DB</Name>
			<Modifier>Input</Modifier>
			<DefaultValue>Data Source=localhost;Initial Catalog=Etl.Database;Integrated Security = true;</DefaultValue>
			<Binding>None</Binding>
			<IsSecure>true</IsSecure>
		</Variable>
		<Variable>
			<Name>SessionId</Name>
			<Modifier>Bound</Modifier>
			<Binding>EtlSessionId</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
		<Variable>
			<Name>SessionDateTime</Name>
			<Modifier>Bound</Modifier>
			<Binding>EtlSessionDateTime</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
		<Variable>
			<Name>SessionDateTimeUtc</Name>
			<Modifier>Bound</Modifier>
			<Binding>EtlSessionUtcDateTime</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
		<Variable>
			<Name>FtpIn</Name>
			<Modifier>Input</Modifier>
			<DefaultValue>ftp://XXX:XXX@host/NewOrders</DefaultValue>
			<Binding>None</Binding>
			<IsSecure>true</IsSecure>
		</Variable>
		<Variable>
			<Name>FtpOut</Name>
			<Modifier>Input</Modifier>
			<DefaultValue>ftp://XXX:XXX@host/NewOrders</DefaultValue>
			<Binding>None</Binding>
			<IsSecure>true</IsSecure>
		</Variable>
		<Variable>
			<Name>FtpEnableSSL</Name>
			<Modifier>Input</Modifier>
			<DefaultValue>False</DefaultValue>
			<Binding>None</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
		<Variable>
			<Name>SourceId</Name>
			<Modifier>Input</Modifier>
			<DefaultValue>0</DefaultValue>
			<Binding>None</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
		<Variable>
			<Name>File</Name>
			<Modifier>Output</Modifier>
			<Binding>None</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
		<Variable>
			<Name>FileNoEx</Name>
			<Modifier>Output</Modifier>
			<Binding>None</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
		<Variable>
			<Name>EtlIsNeedRepeat</Name>
			<Modifier>Output</Modifier>
			<Binding>None</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
		<Variable>
			<Name>BatchSize</Name>
			<Modifier>Input</Modifier>
			<DefaultValue>20</DefaultValue>
			<Binding>None</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
		<Variable>
			<Name>PortalDB</Name>
			<Modifier>Input</Modifier>
			<DefaultValue>Data Source=localhost;Initial Catalog=user;User ID=dmidp; Password=pass;</DefaultValue>
			<Binding>None</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
		<Variable>
			<Name>ResultFile</Name>
			<Modifier>Output</Modifier>
			<Binding>None</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
		<Variable>
			<Name>ResultFileName</Name>
			<Modifier>Output</Modifier>
			<Binding>None</Binding>
			<IsSecure>false</IsSecure>
		</Variable>
	</Variables>
	<Steps>
		<DownloadFile>
			<Name>Получение списка файлов на FTP</Name>
			<TimeoutMilliseconds xsi:nil="true" />
			<Source>
				<Name>FTP</Name>
				<Uri>$(FtpIn)/</Uri>
				<AllowInvalidCertificates>false</AllowInvalidCertificates>
				<Method>NLST</Method>
				<Headers />
			</Source>
			<Destination>
				<Name>Временная папка</Name>
				<FilePath>$(Temp)\$(SessionId)\DirListing.csv</FilePath>
				<CodePage>65001</CodePage>
			</Destination>
		</DownloadFile>
		<ImportCsvFile>
			<Name>Загрузка списка файлов в реестр найденных файлов</Name>
			<TimeoutMilliseconds xsi:nil="true" />
			<Source>
				<Name>Временная папка</Name>
				<FilePath>$(Temp)\$(SessionId)\DirListing.csv</FilePath>
				<CodePage>65001</CodePage>
				<HasHeaders>false</HasHeaders>
				<FieldDelimiter>;</FieldDelimiter>
			</Source>
			<Destination>
				<Name>Реестр найденных файлов</Name>
				<ConnectionString>$(DB)</ConnectionString>
				<ProviderName>System.Data.SqlClient</ProviderName>
				<TableName>dbo.FoundFile</TableName>
			</Destination>
			<BatchSize>10000</BatchSize>
			<Mappings>
				<Mapping>
					<DestinationFieldName>EtlSessionId</DestinationFieldName>
					<DefaultValue>$(SessionId)</DefaultValue>
				</Mapping>
				<Mapping>
					<DestinationFieldName>SourceId</DestinationFieldName>
					<DefaultValue>$(SourceId)</DefaultValue>
				</Mapping>
				<Mapping>
					<SourceFieldName>0</SourceFieldName>
					<DestinationFieldName>FileName</DestinationFieldName>
				</Mapping>
				<Mapping>
					<DestinationFieldName>ScanningDate</DestinationFieldName>
					<DefaultValue>$(SessionDateTime)</DefaultValue>
				</Mapping>
				<Mapping>
					<DestinationFieldName>ScanningDateUTC</DestinationFieldName>
					<DefaultValue>$(SessionDateTimeUtc)</DefaultValue>
				</Mapping>
				<Mapping>
					<SourceFieldName>0</SourceFieldName>
					<DestinationFieldName>FileDate</DestinationFieldName>
					<SourceFieldTranslation>
						<Functions>
							<Parse>
								<Regex>$(FileMask)</Regex>
								<GroupName>date</GroupName>
								<CaseSensitive>false</CaseSensitive>
							</Parse>
						</Functions>
					</SourceFieldTranslation>
				</Mapping>
				<Mapping>
					<SourceFieldName>0</SourceFieldName>
					<DestinationFieldName>FileNumber</DestinationFieldName>
					<SourceFieldTranslation>
						<Functions>
							<Parse>
								<Regex>$(FileMask)</Regex>
								<GroupName>num</GroupName>
								<CaseSensitive>false</CaseSensitive>
							</Parse>
						</Functions>
					</SourceFieldTranslation>
				</Mapping>
				<Mapping>
					<SourceFieldName>0</SourceFieldName>
					<DestinationFieldName>FileType</DestinationFieldName>
					<SourceFieldTranslation>
						<Functions>
							<Match>
								<Rules>
									<Rule>
										<Regex>$(FileMask)</Regex>
										<CaseSensitive>false</CaseSensitive>
										<Result>
											<DefaultValue>$(FileTypeId)</DefaultValue>
										</Result>
									</Rule>
								</Rules>
							</Match>
						</Functions>
					</SourceFieldTranslation>
				</Mapping>
			</Mappings>
			<DataLossBehavior>Fail</DataLossBehavior>
		</ImportCsvFile>
		<ExecuteProcedure>
			<Name>Выбор файла для обработки</Name>
			<TimeoutMilliseconds xsi:nil="true" />
			<Source>
				<Name>Реестр найденных файлов</Name>
				<ConnectionString>$(DB)</ConnectionString>
				<ProviderName>System.Data.SqlClient</ProviderName>
				<ProcedureName>[dbo].[SelectFile4Processing]</ProcedureName>
				<Parameters>
					<Parameter>
						<Name>sessionId</Name>
						<Value>$(SessionId)</Value>
					</Parameter>
					<Parameter>
						<Name>sourceId</Name>
						<Value>$(SourceId)</Value>
					</Parameter>
					<Parameter>
						<Name>fileTypeId</Name>
						<Value>$(FileTypeId)</Value>
					</Parameter>
				</Parameters>
			</Source>
			<OutputVariables>
				<FirstRow>
					<FieldToVariable>
						<SourceFieldName>FileName</SourceFieldName>
						<VariableName>File</VariableName>
					</FieldToVariable>
					<FieldToVariable>
						<SourceFieldName>FileName</SourceFieldName>
						<SourceFieldTranslation>
							<Functions>
								<Parse>
									<Regex>$(FileMask)</Regex>
									<GroupName>name</GroupName>
									<CaseSensitive>false</CaseSensitive>
								</Parse>
							</Functions>
						</SourceFieldTranslation>
						<VariableName>FileNoEx</VariableName>
					</FieldToVariable>
					<FieldToVariable>
						<SourceFieldName>NeedProcessingFilesCount</SourceFieldName>
						<VariableName>EtlIsNeedRepeat</VariableName>
					</FieldToVariable>
				</FirstRow>
			</OutputVariables>
		</ExecuteProcedure>
		<DownloadFile>
			<Name>Скачивание файла для обработки</Name>
			<TimeoutMilliseconds xsi:nil="true" />
			<Source>
				<Name>FTP</Name>
				<Uri>$(FtpIn)/$(File)</Uri>
				<AllowInvalidCertificates>false</AllowInvalidCertificates>
				<Method>RETR</Method>
				<Headers />
			</Source>
			<Destination>
				<Name>Временная директория</Name>
				<FilePath>$(Temp)\$(SessionId)\$(File)</FilePath>
				<CodePage>65001</CodePage>
			</Destination>
		</DownloadFile>
		<InvokeMethod>
			<Name>Вызов оркестратора </Name>
			<TimeoutMilliseconds xsi:nil="true" />
			<Source>
				<Name>Сборка</Name>
				<AssemblyName>BusinessLogic</AssemblyName>
				<TypeName>Sw.Dp.BusinessLogic.ETL.C1Connector</TypeName>
				<MethodName>UpdateNewOrders</MethodName>
				<Parameters>
					<EtlMethodParameter>
						<Name>connectionString</Name>
						<Value>$(PortalDB)</Value>
					</EtlMethodParameter>
					<EtlMethodParameter>
						<Name>xmlFile</Name>
						<Value>$(Temp)\$(SessionId)\$(File)</Value>
					</EtlMethodParameter>
				</Parameters>
			</Source>
		</InvokeMethod>
	</Steps>
</EtlPackage>